--- 
- name: docker-server
  hosts: aws_ec2
  become: yes
  collections:
    - community.docker
  vars:
    prometheus_image: "prom/prometheus:latest"
    node_exporter_image: "quay.io/prometheus/node-exporter:latest"
    prometheus_config_dir: /opt/prometheus
    prometheus_data_dir: /opt/prometheus/data
    image_name: "{{ lookup('env','DOCKERHUB_IMAGE') | default('aliaksinho13/hub-repo:latest', true) }}"
  tasks:
    - name: ensure pip3 is present
      package:
        name: python3-pip
        state: present
    - name: ensure DOCKERHUB_IMAGE env is provided (CI) or fallback used
      assert:
        that:
          - image_name is not none
          - image_name != ''
        fail_msg: "DOCKERHUB_IMAGE is not set and no default is configured. Set the env var in CI or update the playbook variable."
    - name: install docker SDK on remote for Ansible docker modules
      pip:
        name: docker
        state: present
        executable: pip3
        extra_args: --ignore-installed requests urllib3

    - name: make sure docker is installed
      yum:
        name: docker
        update_cache: yes
        state: present

    - name: ensure docker is running 
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Docker Login
      docker_login:
        username: "{{ lookup('env','DOCKERHUB_USERNAME') }}"
        password: "{{ lookup('env','DOCKERHUB_TOKEN') }}"
        registry_url: https://index.docker.io/v1/

    - name: pull docker image
      docker_image:
        name: "{{ image_name }}"
        source: pull

    - name: run docker container
      docker_container:
        name: pet-app
        image: "{{ image_name }}"
        state: started
        restart_policy: always
        ports:
          - "80:80"
######################################################'
    - name: Create Prometheus config directory
      file:
        path: "{{ prometheus_config_dir }}"
        state: directory
        mode: '0755'

    - name: Deploy Prometheus config
      copy:
        dest: "{{ prometheus_config_dir }}/prometheus.yml"
        content: |
          global:
            scrape_interval: 15s

          scrape_configs:
            - job_name: 'node-exporter'
              static_configs:
                - targets: ['localhost:9100']

            - job_name: 'pet-app'
              metrics_path: /healthz
              static_configs:
                - targets: ['localhost:80']

    - name: Fix Prometheus data permissions
      file:
        path: "{{ prometheus_data_dir }}"
        owner: 65534
        group: 65534
        recurse: yes

    - name: Run Prometheus container
      docker_container:
        name: prometheus
        image: "{{ prometheus_image }}"
        state: started
        restart_policy: always
        ports:
          - "9090:9090"
        volumes:
          - "{{ prometheus_config_dir }}/prometheus.yml:/etc/prometheus/prometheus.yml:ro"
          - "{{ prometheus_data_dir }}:/prometheus"

    # --- Node Exporter setup ---
    - name: Run Node Exporter container
      docker_container:
        name: node_exporter
        image: "{{ node_exporter_image }}"
        state: started
        restart_policy: always
        ports:
          - "9100:9100"